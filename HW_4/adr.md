## Title

ADR 0001 

## Status

Proposed

## Context

В начале было принято решение начислять баланс сразу (Связь [COMM-080]). Так проще и быстрее имплементировать. 
Со временем столкнулись с проблемами: снизились или отсутствуют такие характеристики как availability и fault tolerance ( проблема [Problem-080] ). 
Проблема возникает из-за сильной связанности (coupling) и строгой консистентности. 

## Decision

Единственный способ как можно снизить связанность - убрать строгую консистентность и перейти на eventual consistency. Есть разные варианты имплементации, мы возьмем асинхронную коммуникацию через шину. Т.к. это влияет на денежные средства, то в качестве шины возьмем kafka, что бы хранить лог событий. 
В старой имплементации было 2 endpoint’а для начисления и списания средств. В новой, согласно, функционально схемы (см. ES) мы будем использовать два лога: успешно выполененные и не успешно выполненные. 
На логи добавим метрик и алертов, чтобы отслеживать отставание лога и скорость обработки событий. 


## Consequences

Мы отказываемся от строгой консистентности, необходимо повысить observability системы ( добавить дополнительных метрик и оповещений), чтобы быстро видеть если что-то идет не так. 
Необходимо думать над порядком и гарантиями доставки.